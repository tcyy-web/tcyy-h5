<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <title></title>
  <link href="../../fonts/iconfont.css" rel="stylesheet" />
  <link href="../../css/mui.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../../css/mui.picker.min.css">
  <link rel="stylesheet" href="../../css/mui.poppicker.css">
  <link href="../../css/style.css" rel="stylesheet" />
  <link href="../../css/style-custom.css" rel="stylesheet" />
  <link href="css/profile-style.css" rel="stylesheet" />
  <style>
    .mui-content{
      height: auto;
    }
  </style>
</head>

<body id="main-content">
  <header class="mui-bar mui-bar-nav">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title">我的简历信息</h1>
  </header>
  <nav class="mui-bar mui-bar-tab custom-tab">
    <div class="mui-tab-item">
      <button id="saveBtn" class="mui-btn mui-btn-blue">保存</button>
    </div>  
  </nav>
  <div class="mui-content">
    <form class="mui-input-group profile-form-group">
      <h4>基本信息</h4>
      <div class="mui-input-row">
        <label><i class="form-required"></i>姓名：</label>
        <input data-bind="value: formData.personname, muiInput: formData.personname" maxlength="50" type="text" class="mui-input-clear" placeholder="请输入姓名">
      </div>
      <div class="mui-input-row">
        <label><i class="form-required"></i>出生日期：</label>
        <p data-bind="text: !formData.birthday() ? '请选择' : formData.birthday, 
          click: birthdayClick">请选择</p>
      </div>
      <div class="mui-input-row">
        <label><i class="form-required"></i>联系电话：</label>
        <input data-bind="value: formData.telephone, muiInput: formData.telephone" maxlength="20" type="text" class="mui-input-clear" placeholder="请输入联系电话">
      </div>
      <div class="mui-input-row">
        <label><i class="form-required"></i>邮箱：</label>
        <input data-bind="value: formData.email, muiInput: formData.email" maxlength="100" type="text" class="mui-input-clear" placeholder="请输入邮箱">
      </div>
      <div class="mui-input-row">
        <label><i class="form-required"></i>性别：</label>
        <p data-bind="text: !formData.sexText() ? '请选择' : formData.sexText, 
          click: sexPickerClick">请选择</p>
      </div>
      <div class="mui-input-row">
        <label><i class="form-required"></i>学历：</label>
        <p data-bind="text: !formData.educationText() ? '请选择' : formData.educationText, 
          click: educationClick">请选择</p>
      </div>
      <div class="mui-input-row">
        <label>民族：</label>
        <input data-bind="value: formData.ethnic, muiInput: formData.ethnic" maxlength="50" type="text" class="mui-input-clear" placeholder="请输入民族">
      </div>
      <div class="mui-input-row">
        <label>婚姻状况：</label>
        <p data-bind="text: !formData.marriageText() ? '请选择' : formData.marriageText, 
          click: marriagePickerClick">请选择</p>
      </div>
      <div class="mui-input-row">
        <label>居住地址：</label>
        <input data-bind="value: formData.address, muiInput: formData.address" maxlength="100" type="text" class="mui-input-clear" placeholder="请输入居住地址">
      </div>
      <!-- ko if: formData.id() > 0 -->
      <div class="mui-input-row">
        <label>状态：</label>
        <p data-bind="text: auditstatusText"></p>
      </div>
      <!-- /ko -->
      <h4>求职信息</h4>
      <div class="mui-input-row">
        <label><i class="form-required"></i>求职职位：</label>
        <p data-bind="text: !formData.intentpositionText() ? '请选择' : formData.intentpositionText, 
          click: intentpositionPickerClick">请选择</p>
      </div>
      <div class="mui-input-row">
        <label>求职类型：</label>
        <p data-bind="text: !formData.worknatureText() ? '请选择' : formData.worknatureText, 
          click: worknaturePickerClick">请选择</p>
      </div>      
      <div class="mui-input-row">
        <label>在职状态：</label>
        <p data-bind="text: !formData.jobstatusText() ? '请选择' : formData.jobstatusText, 
          click: jobstatusPickerClick">请选择</p>
      </div>
      <div class="mui-input-row">
        <label><i class="form-required"></i>期望地区：</label>
        <p data-bind="text: !formData.expectregion() ? '请选择' : formData.expectregion, 
          click: regionPickerClick">请选择</p>
      </div>
      <div class="mui-input-row">
        <label>期望工资：</label>
        <p data-bind="text: !formData.wagesText() ? '请选择' : formData.wagesText, 
          click: wagesPickerClick">请选择</p>
      </div>
      <div class="mui-input-row">
        <label><i class="form-required"></i>工作日期：</label>
        <p data-bind="text: !formData.jointime() ? '请选择' : formData.jointime,
          click: datePickerClick">请选择</p>
      </div>
      <div class="mui-input-row">
        <label><i class="form-required"></i>工作经验：</label>
        <input data-bind="value: formData.workexperience, muiInput: formData.workexperience" maxlength="20" type="text" class="mui-input-clear" placeholder="请输入工作经验">
      </div>
      <h4>资格证书</h4>
      <div class="profile-form-item">
        <!-- ko foreach: qualificationList -->
        <div data-bind="click: $root.qualificationMaintain.bind(null, $data)" class="flow-box">
          <i data-bind="click: $root.qualificationDelete, clickBubble: false" class="iconfont icon-shanchu-copy"></i>
          <div data-bind="text: qualifyname"></div>
          <div>获得日期：<span data-bind="text: qualify_time"></span></div>
          <div>
            <img data-bind="attr: {src: qualifyurl}" data-preview-src="" data-preview-group="1" />
          </div>
        </div>
        <!-- /ko -->
        <div data-bind="click: qualificationMaintain.bind(null, {})" class="flow-box">
          <div class="mui-text-center"><i class="mui-icon mui-icon-plusempty"></i>添加资格证书</div>
        </div>
      </div>
      <h4>工作经历</h4>
      <div class="profile-form-item">
        <!-- ko foreach: expList -->
        <div data-bind="click: $root.workMaintain.bind(null, $data)" class="flow-box">
          <i data-bind="click: $root.workDelete, clickBubble: false" class="iconfont icon-shanchu-copy"></i>
          <div><span data-bind="text: entrancedate"></span>至<span data-bind="text: dimissiondate"></span></div>
          <div data-bind="text: companyname"></div>
          <!-- ko if: !!positions -->
          <div data-bind="text: positions"></div>
          <!-- /ko -->
        </div>
        <!-- /ko -->
        <div data-bind="click: workMaintain.bind(null, {})" class="flow-box">
          <div class="mui-text-center"><i class="mui-icon mui-icon-plusempty"></i>添加工作经历</div>
        </div>
      </div>
      <h4>教育培训经历</h4>
      <div class="profile-form-item">
        <!-- ko foreach: eduList -->
        <div data-bind="click: $root.educMaintain.bind(null, $data)" class="flow-box">
          <i data-bind="click: $root.educDelete, clickBubble: false" class="iconfont icon-shanchu-copy"></i>
          <div><span data-bind="text: entrancedate"></span>至<span data-bind="text: graduatedate"></span></div>
          <div data-bind="text: schoolname"></div>
          <div data-bind="text: profession"></div>
        </div>
        <!-- /ko -->
        <div data-bind="click: educMaintain.bind(null, {})" class="flow-box">
          <div class="mui-text-center"><i class="mui-icon mui-icon-plusempty"></i>添加教育培训经历</div>
        </div>
      </div>
    </form>
  </div>
  <script src="../../third/bluebird.min.js"></script>
  <script src="../../third/loadash.3.10.1.js"></script>
  <script src="../../js/mui.min.js"></script>
  <script src="../../third/knockout.js"></script>
  <script src="../../third/knockout.extend.js"></script>
  <script src="../../third/ko.mapping.js"></script>
  <script src="../../js/mui.zoom.js"></script>
  <script src="../../js/mui.previewimage.js"></script>
  <script src="../../js/mui.picker.min.js"></script>
  <script src="../../js/mui.poppicker.js"></script>
  <script src="../../js/utils.enums.js"></script>
  <script src="../../js/utils.config.js"></script>
  <script src="../../js/utils.storages.js"></script>
  <script src="../../js/utils.auth.js"></script>
  <script src="../../js/utils.upload.js"></script>
  <script src="../../js/utils.request.js" ></script>
  <script src="../../js/utils.common.js" ></script>
  <script src="js/profile-common.js" ></script>
  <script>
    (function($, doc) {
      $.init({
        preloadPages:[{
          id:'kz_profile_MyResume_work',
          url: './my-resume-work.html'
        }, 
        {
          id:'kz_profile_MyResume_educ',
          url: './my-resume-educ.html'
        },
        {
          id:'kz_profile_MyResume_quali',
          url: './my-resume-quali.html'
        }],
      });
      $.plusReady(function() {
        $.previewImage();
        function CheckSave() {
          return new Promise(function(resolve) {
            ProfileResumeCheck(true).then(function(){
              resolve()
            }).catch(function(){
              mui.toast('请先保存简历信息');
            });
          });
        }
        var birthdayPicker = new $.DtPicker({
          type: 'date',
          beginYear: '1950',
          endYear: config.dateEnd
        });
        // 初始化性别选择
        var sexPicker = new $.PopPicker({
        });
        sexPicker.setData([
          { value: 1, text: '男'},
          { value: 2, text: '女'}
        ]);
        // 初始化学历选择
        var educationPicker = new $.PopPicker({
        });
        // 初始化婚姻选择
        var marriagePicker = new $.PopPicker({
        });
        marriagePicker.setData([
          { value: 2, text: '已婚'},
          { value: 1, text: '未婚'}
        ]);
        // 初始化职位选择
        var intentpositionPicker = new $.PopPicker({
        });
        // 初始化求职类型选择
        var worknaturePicker = new $.PopPicker({
        });
        worknaturePicker.setData([
          { value: 1, text: '全职'},
          { value: 2, text: '兼职'}
        ]);
        // 初始化在职状态选择
        var jobstatusPicker = new $.PopPicker({
        });
        jobstatusPicker.setData([
          { value: 1, text: '在职'},
          { value: 2, text: '离职'}
        ]);
        // 初始化区域选择
        var areaPicker = new $.PopPicker({
          layer: 3
        });
        ProfileArea().then(function(areas) {
          areaPicker.setData(areas);          
        });
        // 初始化期望工资选择
        var wagesPicker = new $.PopPicker({
        });
        // 初始化日期选择
        var datepicer = new $.DtPicker({
          type: 'date',
          beginYear: config.dateBegin,
          endYear: config.dateEnd
        });
        Enums.getAll(function(){
          educationPicker.setData(
            _.map(_.cloneDeep(Enums.getEnums('education')), function(o) {
              return {
                value: o.dict_value,
                text: o.dict_name
              }
            })
          );
          intentpositionPicker.setData(
            _.map(_.cloneDeep(Enums.getEnums('positionType')), function(o) {
              return {
                value: o.dict_value,
                text: o.dict_name
              }
            })
          );
          wagesPicker.setData(
            _.map(_.cloneDeep(Enums.getEnums('salaryRange')), function(o) {
              return {
                value: o.dict_value,
                text: o.dict_name
              }
            })
          );
        })
        var BaseView = function () {
          var vm = this;
          vm.formData = {
            id: ko.observable(),
            personname: ko.observable(),
            birthday: ko.observable(),
            telephone: ko.observable(),
            email: ko.observable(),
            sex: ko.observable(),
            sexText: ko.observable(''),
            //学历
            education: ko.observable(),
            educationText: ko.observable(''),
            ethnic: ko.observable(),
            marriage: ko.observable(),
            marriageText: ko.observable(''),
            address: ko.observable(),
            // 求职职位
            intentposition: ko.observable(),
            intentpositionText: ko.observable(''),
            // 求职类型
            worknature: ko.observable(),
            worknatureText: ko.observable(''),
            // 在职状态
            jobstatus: ko.observable(),
            jobstatusText: ko.observable(''),
            // 期望地区
            expectregion: ko.observable(''),  
            regionid: ko.observable(),
            // 期望工资
            wages: ko.observable(),  
            wagesText: ko.observable(''),
            jointime: ko.observable(),
            workexperience: ko.observable(),
            auditstatus: ko.observable()
          }
          // 状态显示文本
          vm.auditstatusText = ko.computed(function(){
            if (vm.formData.auditstatus() == 1) {
              return '待审核'
            } else if (vm.formData.auditstatus() == 2) {
              return '审核通过'
            } else if (vm.formData.auditstatus() == 3) {
              return '审核不通过'
            }
            return ''
          })
          // 教育经历
          vm.eduList = ko.observableArray([]);
          // 工作经历
          vm.expList = ko.observableArray([]);
          // 资格证书
          vm.qualificationList = ko.observableArray([]);
          vm.birthdayClick = function(){
            setTimeout(function() {
              birthdayPicker.show(function(rs) {
                viewModel.formData.birthday(rs.text);
              });
            }, 500);
          }
          vm.educationClick = function(){
            setTimeout(function() {
              educationPicker.show(function(items) {
                vm.formData.education(items[0].value);
                vm.formData.educationText(items[0].text);
              });
            }, 500);
          }
          vm.sexPickerClick = function(){
            setTimeout(function() {
              sexPicker.show(function(items) {
                vm.formData.sex(items[0].value);
                vm.formData.sexText(items[0].text);
              });
            }, 500);
          }
          vm.marriagePickerClick = function(){
            setTimeout(function() {
              marriagePicker.show(function(items) {
                vm.formData.marriage(items[0].value);
                vm.formData.marriageText(items[0].text);
              });
            }, 500);
          }
          vm.regionPickerClick=function() {
            setTimeout(function() {
              areaPicker.show(function(items) {
                var result = _.reduce(items, function(a, b){  
                  if (b.id > 0) {
                    return a + b.name
                  }  
                  return a;
                }, '');
                var resultid = _.reduce(items, function(a, b){  
                  if (b.id > 0) {
                    if (!a) {
                      return a + b.id
                    } else {
                      return a + '-' + b.id
                    }
                  }    
                  return a;
                }, '');
                vm.formData.expectregion(result);
                vm.formData.regionid(resultid);
              });
            }, 500);
          }
          vm.datePickerClick = function () {
            setTimeout(function() {
              datepicer.show(function(rs) {
                viewModel.formData.jointime(rs.text);
              });
            }, 500);
          }
          vm.intentpositionPickerClick = function () {
            setTimeout(function() {
              intentpositionPicker.show(function(items) {
                vm.formData.intentposition(items[0].value);
                vm.formData.intentpositionText(items[0].text);
              });
            }, 500);
          }
          vm.worknaturePickerClick = function (){
            setTimeout(function() {
              worknaturePicker.show(function(items) {
                vm.formData.worknature(items[0].value);
                vm.formData.worknatureText(items[0].text);
              });
            }, 500);
          }
          vm.jobstatusPickerClick = function () {
            setTimeout(function() {
              jobstatusPicker.show(function(items) {
                vm.formData.jobstatus(items[0].value);
                vm.formData.jobstatusText(items[0].text);
              });
            }, 500);
          }
          vm.wagesPickerClick = function(){
            setTimeout(function() {
              wagesPicker.show(function(items) {
                vm.formData.wages(items[0].value);
                vm.formData.wagesText(items[0].text);
              });
            }, 500);
          }
          // 资格证书维护
          vm.qualificationMaintain = function (data) {
            CheckSave().then(function(){
              var nextWebview = plus.webview.getWebviewById('kz_profile_MyResume_quali');
              $.fire(nextWebview, 'kz_profile_MyResume_quali_Data', data);
              $.openWindow({
                id:'kz_profile_MyResume_quali',               
              }); 
            });
          }
          vm.qualificationDelete = function(data) {
            mui.confirm('确定删除该资格证书？', function(ok){
              if (ok.index == 0) {
                request.loginAjax('personalresume/delQualification', {
                  data: {
                    id: data.id
                  }
                }, function(data,success) {     
                  if (success) {
                    loadList();
                  }
                });
              }
            })
          }
          // 工作经历维护
          vm.workMaintain = function (data) {
            CheckSave().then(function(){
              var nextWebview = plus.webview.getWebviewById('kz_profile_MyResume_work');
              $.fire(nextWebview, 'kz_profile_MyResume_work_Data', data);
              $.openWindow({
                id:'kz_profile_MyResume_work',               
              }); 
            });
          }
          vm.workDelete = function(data) {
            mui.confirm('确定删除该工作经历？', function(ok){
              if (ok.index == 0) {
                request.loginAjax('personalresume/delWorkExperience', {
                  data: {
                    id: data.id
                  }
                }, function(data,success) {     
                  if (success) {
                    loadList();
                  }
                });
              }
            })
          }
          // 教育经历维护
          vm.educMaintain = function(data) {
            CheckSave().then(function(){
              var nextWebview = plus.webview.getWebviewById('kz_profile_MyResume_educ');
              $.fire(nextWebview, 'kz_profile_MyResume_educ_Data', data);
              $.openWindow({
                id:'kz_profile_MyResume_educ',               
              }); 
            });
          }
          vm.educDelete = function(data){
            mui.confirm('确定删除该教育培训经历？', function(ok){
              if (ok.index == 0) {
                request.loginAjax('personalresume/delEducation', {
                  data: {
                    id: data.id
                  }
                }, function(data,success) {     
                  if (success) {
                    loadList();
                  }
                });
              }
            })
          }
        }
        var viewModel = new BaseView();
        ko.applyBindings(viewModel, document.getElementById('main-content'));  
        // 加载简历信息
        function loadPage () {
          return new Promise(function(resolve) {
            request.loginAjax('personalresume/getPersonalResumeDetail', {
              showMsg: false
            }, function(data,success) {     
              if (success) {
                _.forEach(viewModel.formData, function(n, key) {
                  n(data[key]);
                });
                resolve();
                Enums.getAll(function(){
                  if (data.sex > 0) {
                    viewModel.formData.sexText(data.sex == 1 ? '男' : '女');
                  }
                  viewModel.formData.educationText(Enums.getEnumText('education', data.education));
                  if (data.marriage > 0) {
                    viewModel.formData.marriageText(data.marriage == 1 ? '未婚' : '已婚');
                  }
                  viewModel.formData.intentpositionText(Enums.getEnumText('positionType', data.intentposition));
                  if (data.worknature > 0) {
                    viewModel.formData.worknatureText(data.worknature == 1 ? '全职' : '兼职');
                  }
                  if (data.jobstatus > 0) {
                    viewModel.formData.jobstatusText(data.jobstatus == 1 ? '在职' : '离职');
                  }
                  viewModel.formData.wagesText(Enums.getEnumText('salaryRange', data.wages));
                });
              }
            });
          });
          
        }
        // 查询证书、工作经历、教育经历列表
        function loadList () {
          request.loginAjax('personalresume/viewResumeDetail', {
            showMsg: false,
            data: {
              id: viewModel.formData.id()
            }
          }, function(data,success) {     
            if (success) {
              viewModel.eduList(data.eduList);
              viewModel.expList(data.expList);
              _.map(data.qualificationList, function(item){
                item.qualifyurl = config.serverUrl + item.qualifyurl;
              });
              viewModel.qualificationList(data.qualificationList);
            }
          });
        }
        loadPage().then(function(){
          loadList();
        });
        //保存简历
        saveResume = function () {
          return new Promise(function(resolve){
            var postData = ko.mapping.toJS(viewModel.formData);
            if (!postData.personname) {
              mui.toast('请输入姓名')
              return
            }
            if (!postData.birthday) {
              mui.toast('请选择出生日期')
              return
            }
            if (!postData.telephone) {
              mui.toast('请输入联系电话')
              return
            }
            if (!postData.email) {
              mui.toast('请输入邮箱')
              return
            }
            if (!postData.sexText) {
              mui.toast('请选择性别')
              return
            }
            if (!postData.intentpositionText) {
              mui.toast('请选择求职职位')
              return
            }
            if (!postData.expectregion || !postData.regionid) {
              mui.toast('请选择期望地区')
              return
            }
            if (!postData.jointime) {
              mui.toast('请选择工作日期')
              return
            }
            if (!postData.workexperience) {
              mui.toast('请输入工作经验')
              return
            }
            request.loginAjax('personalresume/savePersonalResume', {
              data: postData
            }, function(data,success) {     
              if (success) {   
                resolve()
              }
            });
          });
        }
        doc.getElementById('saveBtn').addEventListener('tap', function(e) {
          saveResume().then(function(){
            loadPage();
          });
        });
        // 资格证书刷新
        window.addEventListener('kz_profile_MyResume_quali_Refresh', function(e){
          loadList();
        });
        //工作经历刷新
        window.addEventListener('kz_profile_MyResume_workRefresh', function(e){
          loadList();
        });
        //教育经历刷新
        window.addEventListener('kz_profile_MyResume_educRefresh', function(e){
          loadList();
        });
      });
    }(mui, document));
  </script>
</body>
</html>