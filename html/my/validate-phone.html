<!DOCTYPE html>
<html class="ui-page-my">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title></title>
	<link href="../../css/mui.min.css" rel="stylesheet" />
	<link href="../../css/style.css" rel="stylesheet" />
	<style type="text/css">
		.mui-input-row{ position: relative;}
		.mui-input-row .mui-btn{ position: absolute; right: 2px; top: 0; width: auto;}
	</style>

</head>

<body>
<header class="mui-bar mui-bar-nav">
	<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	<h1 class="mui-title">手机认证</h1>
</header>
<div class="mui-content"  id="content">
<form class="mui-input-group">
	<div class="mui-input-row">
		<label>手机号码</label>
		<input id="tel" type="text" placeholder="请输入手机号">
	</div>
	<div class="mui-input-row">
		<label>验证码</label>
		<input id="code" type="text" placeholder="请输入验证码" >
		<button id="sendmsg" type="button" class="mui-btn mui-btn-primary" >发送短信</button>
	</div>

</form>
</div>
<script src="../../js/mui.min.js"></script>
<script src="../../js/mui.pullToRefresh.js"></script>
<script src="../../js/mui.pullToRefresh.material.js"></script>
<script src="../../js/utils.config.js"></script>
<script src="../../js/utils.extend.js"></script>
<script src="../../js/utils.storages.js" ></script>
<script src="../../js/utils.category.js" ></script>
<script src="../../js/utils.auth.js"></script>
<script src="../../js/utils.request.js"></script>
<script type="text/javascript">
(function($, doc) {

$.init();

$.plusReady(function() {

	var canSend = true;
	var _timer;
	document.getElementById("sendmsg").addEventListener("tap",function(){
		var _this = this;
		if( !canSend ){ return; }
    	var oTel = document.getElementById("tel");
    	var oCode = document.getElementById("code");
    	if( oTel.value == ""||oTel.value.length != 11  ){
    		$.toast("请输入正确手机号");
    		return;
    	}
    	
    	
    	this.classList.add("mui-disabled");
    	canSend = false;
    	askCode( oTel.value );
		
		clearTimeout( _timer );
    	_timer = setTimeout(function(){
    		_this.classList.remove("mui-disabled");
    		canSend = true;
    	},10000);
	});
	
	document.getElementById("code").addEventListener("keyup",function(){
		if( this.value.length == 6){
			var oTel = document.getElementById("tel");
			if( oTel.value.length == 11 ){
				validateCode( oTel.value , this.value );	
			}else{
				this.value = "";
			}
			
		}

	});
	
	
});


function askCode( phone ){
//	Sendmsg/sendCode type =4
request.loginAjax('Sendmsg/sendCode', {
	data:{
		phone:phone,
		type:4
	},
	showMsg:false,
	showLoading:false
  }, function(data, success) {
  	
    if (success) {
		console.log( data )
		$.toast("短信发送成功");
    }
});
}

function validateCode( phone , code ){
	request.loginAjax('User/bindPhone', {
	data:{
		phone:phone,
		msgcode:code
	},
	showMsg:false,
	showLoading:false
  }, function(data, success) {
  	
    if (success) {
		$.toast("绑定成功");
		$.back();
    }
});
}


})( mui , document )
</script>

</body>

</html>