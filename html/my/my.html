<!DOCTYPE html>
<html class="ui-page-my">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title></title>
	<link href="../../css/mui.min.css" rel="stylesheet" />
	<link rel="stylesheet" href="../../css/mui.picker.min.css">
	<link rel="stylesheet" href="../../css/mui.poppicker.css">
	<link href="../../css/style.css" rel="stylesheet" />
<style>
	.mui-content>.mui-table-view:first-child{margin-top: 0;}
	.mui-table-view-chevron .mui-table-view-cell{padding-right: 40px;}
	.mui-navigate-right:after, .mui-push-right:after{ content: ''; }
	.mui-table-view-cell>a:not(.mui-btn){ color: #999;}
	.mui-navigate-right span{position: absolute;}
	.mui-pull-right{ font-style: normal; color: #333; text-align: right; width: 100%;}
	#headurl img{ width: 40px; height: 40px;}
</style>

</head>

<body>
<header class="mui-bar mui-bar-nav">
	<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	<h1 class="mui-title">个人资料</h1>
</header>
<div class="mui-content">
<ul class="mui-table-view mui-table-view-chevron">
	<li class="mui-table-view-cell">
		<a href="#about" class="mui-navigate-right"><span>头像</span> <i id="headurl" class="mui-pull-right">
			<img src="" alt="" />
		</i></a>
	</li>
	<li class="mui-table-view-cell">
		<a href="#about" class="mui-navigate-right"><span>昵称 </span><i id="nickname" class="mui-pull-right" contenteditable="true"></i></a>
	</li>
	<li class="mui-table-view-cell">
		<a href="#about" class="mui-navigate-right"><span>性别 </span><i id="sex" class="mui-pull-right"></i></a>
	</li>
	<li class="mui-table-view-cell">
		<a href="#about" class="mui-navigate-right"><span>电话 </span><i id="phone" class="mui-pull-right" contenteditable="true"></i></a>
	</li>
	<li class="mui-table-view-cell">
		<a href="#about" class="mui-navigate-right"><span>所在地 </span><i id="province" class="mui-pull-right" contenteditable="true"></i></a>
	</li>
	<li class="mui-table-view-cell">
		<a href="#about" class="mui-navigate-right"><span>微信 </span><i id="weixin" class="mui-pull-right" contenteditable="true"></i></a>
	</li>
	<li class="mui-table-view-cell">
		<a href="#about" class="mui-navigate-right"><span>QQ </span><i id="qq" class="mui-pull-right" contenteditable="true"></i></a>
	</li>
	<li class="mui-table-view-cell">
		<a href="#about" class="mui-navigate-right"><span>Email </span><i id="email" class="mui-pull-right" contenteditable="true"></i></a>
	</li>
</ul>
</div>
<script src="../../js/mui.min.js"></script>
<script src="../../js/mui.picker.min.js"></script>
<script src="../../js/mui.poppicker.js"></script>
<script src="../../js/utils.enums.js"></script>
<script src="../../js/utils.config.js"></script>
<script src="../../js/utils.storages.js"></script>
<script src="../../js/utils.auth.js"></script>
<script src="../../js/utils.upload.js"></script>
<script src="../../js/utils.request.js" ></script>

<script>
	(function($, doc) {
		$.init({beforeback: function() {
			var webview_parent = plus.webview.getWebviewById("WDJL");
			mui.fire( webview_parent, 'refresh');
		}});
		$.plusReady(function() {
			addEvent();
			ajaxData();
		});
		

		function ajaxData() {
			request.loginAjax('User/getInfo', {
				showMsg: false
			}, function(data, success) {

				if(success) {

					render( data );
				}
			});
		}
		
		function setData( name , value , fnEnd){
			var postData = {}
			postData[name] = value;
			
			request.loginAjax('User/saveDataByFiled', {
				
				data: {"field": postData}
				
			}, function(data, success) {

				typeof fnEnd =="function"&&fnEnd(data , success);
			});
		}
		
		function render( obj ){
			var arr = doc.querySelectorAll(".mui-pull-right");
			$.each( arr , function() {
				var name = this.getAttribute("id");
				if( name == "headurl"){
					
				}else if( name =="sex"){
					this.innerText = obj[name]==1?"男":"女";
				}else{
					this.innerText = obj[name];
				}
			});
		}
		var imageurl = null;
		function uploadImage( target ){
			setTimeout(function(){
              upload.showImgActionSheet(function( data ){
                var url = config.url + "Uploads/Files";
                upload.uploadimge( url , data.divid, function(res) {
                 
                 imageurl = res[0].showUrl;
                 target.innerHTML = "<img src="+imageurl+">"
                 imageurl&&setData( "headurl" , imageurl ,function(){
					imageurl = null;
					
				 });
				
                });
              });         
			}, 500);
		}

		function addEvent() {
			var oTableCell = doc.querySelectorAll(".mui-table-view-cell .mui-pull-right");

			$.each(oTableCell, function() {

				this.addEventListener("tap", function() {
					this._text = this.innerText;
					var name = this.getAttribute("id");
					if( name == "headurl"){
						uploadImage( this );
						
					}else if( name =="sex"){
						selectSex.call(this);
					}
					
				});
				this.addEventListener("blur", function() {
					if(this._text != this.innerText){
						console.log("difference");
						var name = this.getAttribute("id");
						var txt = this.innerText;
						
						var callback = function(data ,sucess){
							if(!sucess){
								this.innerText = this._text;
							}
						}
						if( name == "headurl"){
							
						}else if( name =="sex"){
//							txt =="男"?"1":"2";
//							setData( name , txt ,callback );
						}else{
							setData( name , txt , callback );
						}
					};

				});
			})
		}
		//性别
		  var gender = [];
		  for (var key in enums.sex) {
		    gender.push({
		      value: key,
		      text: enums.sex[key]
		    })
		  }
		  var genderPicker = new $.PopPicker();
		  genderPicker.setData(gender);
		function selectSex(){

		  var _this = this;

		  genderPicker.show(function(items) {
		      sex = items[0].value;
		      _this.innerText = items[0].text;
		      setData( "sex" , sex );
		  });
		 
		}
		

}(mui, document));
</script>
</body>

</html>