<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>提交清单</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/mui.picker.min.css">
		<link rel="stylesheet" href="../../css/mui.poppicker.css">
		<link href="../../css/style.css" rel="stylesheet" />
		<style>
			::-moz-placeholder {
				color: #000000;
			}
			:-ms-input-placeholder {
				color: #000000;
			}
			::-webkit-input-placeholder {
				color: #000000;
			}
			body{
				background-color: #ffffff;
			}
			.mui-content {
				height: auto;
				padding-bottom: 60px;
				background-color: #ffffff;
			}
			.bill-item {
				position: relative;
				padding:10px;
				line-height: 20px;
				background-color: #ffffff;
			}
			.bill-item:after{
				position: absolute;
		    right: 0;
		    bottom: 0;
		    left: 0;
		    height: 1px;
		    content: '';
		    -webkit-transform: scaleY(.5);
		    transform: scaleY(.5);
		    background-color: #d6d6d6;
			}
			.bill-item p:first-child {
				position: relative;
				width: 80px;
			}
			.bill-item p:first-child:before {
				position: absolute;
				right: 0;
				top: 0;
				content: '';
				width: 1px;
				height: 100%;
				background-color: #d6d6d6;
			}
			.bill-item p {
				text-align: left;
				padding: 0 5px;
				color: #292929;
			}
			.bill-item p:last-child {
				text-align: right;
				font-size: 18px;
				color: #f34336;
			}
			.bill-item p span {
        color: #f34336;
        margin-left: 10px;
      }
			.bill-item p:last-child span {
				font-size: 14px;
				color: #bbbbbb;
				margin-left: 0;
			}
			form {
				margin-top: 10px;
				margin-bottom: 10px;
			}
			.mui-input-group .mui-input-row{
				height: 50px;
			}
			.mui-input-row label{
				padding: 15px 10px;
				line-height: 20px;
				width: 80px;
				text-align: right;
			}
			.mui-input-group input{
				height: 50px;
				font-size: 14px;
				padding: 15px;
			}
			.mui-input-row label~input{
				width: calc(100% - 80px);
				width: -webkit-calc(100% - 80px);
			}
			.mui-input-row label~p{
				width: calc(100% - 80px);
				width: -webkit-calc(100% - 80px);
				float: right;
				line-height: 50px;
				color: #000000;
			}
			.mui-input-group .mui-input-row:after{
				left: 0;
			}
			.mui-input-group .mui-input-row:last-child:after{
				height: 0;
			}
			.mui-input-row .mui-input-clear~.mui-icon-clear{
				top: 15px;
			}
			.add-pic {
        position: relative;
        margin-top: 10px;
        margin-bottom: 10px;
        background-color: #ffffff;
        padding: 30px;
        text-align: center;
      }
      .add-pic:before,
      .add-pic:after{
        position: absolute;
        right: 0;
        left: 0;
        height: 1px;
        content: '';
        -webkit-transform: scaleY(.5);
        transform: scaleY(.5);
        background-color: #d6d6d6;
      }
      .add-pic:before{
        top: 0;
      }
      .add-pic:after{
        bottom: 0;
      }
      .add-box {
        display: inline-block;
        text-align: center;
      }
      .add-box p {
        color: #b3b3b3;
        font-size: 14px;
        margin-top: 5px;
      }
      .add-box .ap-jia{
        border: 1px dotted #d2d2d2;
        width: 40px;
        height: 40px;
        -webkit-border-radius: 5px;
        border-radius: 5px;
      }
      .add-box .ap-jia img{
        max-width: 100%;
        max-height: 100%;
      }
			.btns {
				position: fixed;
				bottom: 0;
				left: 0;
				font-size: 18px;
				color: #ffffff;
				text-align: center;
				height: 60px;
				line-height: 60px;
				border: 0;
				padding: 0;
				width: 100%;
			}
			.btns .sure{
				background-color: #765fc3;
			}
			.btns .cancel{
				background-color: #f14434;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">提交清单</h1>
		</header>
		<div class="mui-content">
		  <div id="listBox">
    			<div class="bill-item flex">
    				<p>01by</p>
    				<p class="flex-1">牙齿修复<span>*1</span></p>
    				<p class="flex-1">￥318.00<span>元</span></p>
    			</div>
			</div>
			<form class="mui-input-group">
				<div class="mui-input-row">
	        <label>姓名：</label>
	        <input id="name" type="text" class="mui-input-clear" placeholder="请输入姓名">
		    </div>
				<div class="mui-input-row">
	       	<label>性别：</label>
					<p id="showGenderPicker">请选择性别</p>
		    </div>
		    <div class="mui-input-row">
					<label>年龄：</label>
					<input id="age" class="mui-input-clear" type="number" placeholder="请输入年龄" />
				</div>
				<div class="mui-input-row">
					<label>电话：</label>
					<input id="phone" class="mui-input-clear" type="number" placeholder="请输入电话" />
				</div>
				<div class="mui-input-row">
					<label>预约：</label>
					<p id="booktime">请选择预约时间</p>
				</div>
				<div class="mui-input-row">
          <label>接诊师：</label>
          <input id="jzs" type="text" class="mui-input-clear" placeholder="请输入姓名">
        </div>
        <div class="mui-input-row">
          <label>主诊师：</label>
          <input id="zzys" type="text" class="mui-input-clear" placeholder="请输入姓名">
        </div>
			</form>
			<div class="add-pic">
        <div id="bill-addpic" class="add-box">
          <div style="display: inline-block;">
            <div class="ap-jia flex flex-col-center flex-row-center">
              <img id="img" src="../../images/project/jia.png" />
            </div>
          </div>
          <p>上传图片</p>
        </div>
      </div>
			<div class="btns flex">
				<div id="submit" class="flex-1 sure">提交</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.picker.min.js"></script>
		<script src="../../js/mui.poppicker.js"></script>
    <script src="../../js/utils.config.js"></script>
    <script src="../../js/utils.extend.js"></script>
    <script src="../../js/utils.enums.js"></script>
    <script src="../../js/utils.storages.js" ></script>
    <script src="../../js/utils.auth.js"></script>
    <script src="../../js/utils.upload.js"></script>
    <script src="../../js/utils.request.js"></script>
		<script>
			(function($, doc) {
				$.init();
				$.plusReady(function() {
				  var groupid = 0;
				  var list = [];
				  var $listBox = doc.getElementById('listBox');
				  var $submit = doc.getElementById('submit');
				  //
				  var sex = null;
          var $sex = doc.getElementById('showGenderPicker');
          var $name = doc.getElementById('name');
          var $age = doc.getElementById('age');
          var $phone = doc.getElementById('phone');
          var booktime = null;
          var $booktime = doc.getElementById('booktime');
          var $jzs = doc.getElementById('jzs');
          var $zzys = doc.getElementById('zzys');
          var $img = doc.getElementById('img');
				  // 画清单每项
          var paintItem = function(data) {
            var boxDiv = doc.createElement('div');
            boxDiv.className = 'bill-item flex';
            var _p = eval(data.num + '*' + data.price);
            boxDiv.innerHTML = '<p>{0}</p><p class="flex-1">{1}<span>*{2}</span></p><p class="flex-1">￥{3}<span>元</span></p>'.format(data.number,data.title,data.num,_p.toFixed(2));
            $listBox.appendChild(boxDiv);
          }
          // 更新清单
				  var refreshList = function(){
				    $listBox.innerHTML = '';
				    $.each(list, function(index, i) {
				    	 paintItem(i);
				    });
				  }
	        // 清单更新
          window.addEventListener('bill-refresh', function(e){
             list = e.detail.list;
             groupid = e.detail.groupid;
             refreshList();
             $name.value = '';
             sex = null;
             $sex.innerText = '请选择性别';
             $age.value = '';
             $phone.value = '';
             $jzs.value = '';
             $zzys.value = '';
             booktime = null;
             $booktime.innerText = '请选择预约时间';
             $img.src = '../../images/project/jia.png';
          });
          // 提交清单
          //性别
          var gender = [];
          for (var key in enums.sex) {
            gender.push({
              value: key,
              text: enums.sex[key]
            })
          }
          var genderPicker = new $.PopPicker();
          genderPicker.setData(gender);
          $sex.addEventListener('tap', function(event) {
            	setTimeout(function(){
  	            genderPicker.show(function(items) {
  	              sex = items[0].value;
  	              $sex.innerText = items[0].text;
  	            });
            	},500);
          }, false);
          // 预约时间
          var datepicer = new $.DtPicker({});
          $booktime.addEventListener('tap', function(event) {
            	setTimeout(function(){
  	            datepicer.show(function(rs) {
  	              $booktime.innerText = rs.text;
  	              booktime = rs.text;
  	            });
            	},500);
          }, false);
          //选择图片
          var $addPic = doc.getElementById('bill-addpic');
          var divid = '';
          $addPic.addEventListener('tap', function(event) {
            var _this = this;
            setTimeout(function(){
              upload.showImgActionSheet(_this , function( data ){
                $img.src = data.abspath;
                divid = data.divid;
              });             
            }, 500);
          });
          //提交
          $submit.addEventListener('tap', function(e) {
            var name = $name.value.trim();
            var age = $age.value.trim();
            var phone = $phone.value.trim();
            var jzs = $jzs.value.trim();
            var zzys = $zzys.value.trim();
            if (list.length <= 0) {
              return;
            }
            if (name === '') {
              $.toast('请输入姓名');
              return;
            }
            if (sex === null) {
              $.toast('请选择性别');
              return;
            }
            if (age === '') {
              $.toast('请输入年龄');
              return;
            }
            if (phone === '') {
              $.toast('请输入电话');
              return;
            }
            if (booktime === null) {
              $.toast('请选择预约时间');
              return;
            }
            if (jzs === '') {
              $.toast('请输入接诊师姓名');
              return;
            }
            if (zzys === '') {
              $.toast('请输入主诊师姓名');
              return;
            }
            var url = config.url + "Uploads/Files";
            upload.uploadimge( url , divid, function(res) {
              request.loginAjax('project/saveplan', {
                data: {
                  groupid: groupid,
                  name: name,
                  sex: sex,
                  age: age,
                  phone: phone,
                  booktime: booktime,
                  jzs:jzs,
                  zzys: zzys,
                  data: list,
                  image:res[0].showUrl
                }
              }, function(data, success) {
                if (success){
                   //获得父页面的webview
                  var parent = plus.webview.currentWebview().opener();
                  $.fire(parent, 'bill-success');
                  $.back();               
                }
              });
            }, {
              type: '4'
            });
          });
				});
			}(mui, document));
		</script>
	</body>

</html>