<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../css/iconfont.css" />
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/mui.picker.min.css">
		<link href="../../css/style.css" rel="stylesheet" />
		<style>
		  .dateinfo{
		    height: 50px;
		    color: #626f7f;
		    font-size: 20px;
		    font-weight: 700;
		    line-height: 50px;
		  }
		  .dateinfo .iconfont{
		    font-size: 20px;
		    margin: 0 40px 0 20px;
		  }
		  .date{
		    color: #798694;
		  }
		  .date-week{
		    padding: 0 10px;
		    text-align: center;
		    line-height: 30px;
		    font-size: 12px;
		  }
		  .date-month-box{
		    padding: 10px;
		  }
		  .date-month{
		    border-top: 1px solid #e7ebef;
		  }
		  .date-month .item{
		    padding: 0 5px;
		    width: calc(100% / 7);
		    width: -webkit-calc(100% / 7);
		    height: 64px;
		    border: 1px solid #e7ebef;
		    float: left;
		    border-left: 0;
		    border-top: 0;
		    font-size: 12px;
		    overflow: hidden;
		  }
		  .date-month .item:nth-child(7n + 1){
		    border-left: 1px solid #e7ebef;
		  }
		  .date-month .item ._date{
		    color: #d8dee5;
		    text-align: right;
		    height: 20px;
		    line-height: 20px;
		  }
		  .date-month .item.cur ._date{
		    color: #6b7989;
		  }
		  .date-month .item.today{
		    background-color: #765fc3;
		  }
		  .date-month .item.today ._date{
		    color: #fff;
		  }
		  .date-month .item ._item{
		    margin-bottom: 2px;
		    height: 5px;
		    padding-left: 5px;
		    max-width: 100%;
		    -webkit-border-radius: 5px;
		    border-radius: 5px;
		    background-color: #0080ff;
		    color: #fff;
		    overflow: hidden;
		    white-space: nowrap;
		    text-overflow: ellipsis;
		  }
		  .hidebg{
		    position: absolute;
		    top: 0;
		    left: 0;
		    right: 0;
		    bottom: 0;
		    z-index: 1000;
		    background-color: rgba(0,0,0,0.5);
		    padding: 50px 10px;
		    display: none;
		  }
		  .hidebg .mui-icon{
        position: absolute;
        color: #fff;
        right: 10px;
        top: 10px;
      }
		  .form-item {
        position: relative;
        background-color: #ffffff;
        padding: 15px;
        line-height: 20px;
      }
      .form-item:after{
        position: absolute;
        right: 0;
        bottom: 0;
        left: 0;
        height: 1px;
        content: '';
        -webkit-transform: scaleY(.5);
        transform: scaleY(.5);
        background-color: #d6d6d6;
      }
      .form-item > p{
        padding-left: 5px;
        color: #7c7c7c;
        font-size: 14px;
      }
      .form-item > p:first-child{
        padding-left: 0;
      }
      .form-item > p:last-child{
        width: 85px;
        color: #ffae00;
      }
      .form-item > p.status2{
        color: #f14434;
      }
      .form-item > p.status3{
        color: #4cd964;
      }
      .form-item > p .iconfont{
        font-size: 18px;
        vertical-align: middle;
        margin-right: 2px;
      }
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">预约</h1>
		</header>
		<div id="yuyueDate" class="mui-content" >
		  <div class="datebox">
		    <div id="dateinfo" class="dateinfo">
		      <span class="iconfont icon-riliriqi"></span><span id="datetxt"></span>
		    </div>
		    <div id="datebox" class="date">
    		    <div class="date-week flex">
    		      <!-- ko 'foreach':headStr -->
            <div class="flex-1">
              <span data-bind="text: $data"></span>
            </div>
            <!-- /ko -->
          </div>
          <div class="date-month-box">
            <div class="date-month clearFix">
              <!-- ko 'foreach':MonthData -->
              <div class="item cur" data-bind="click: $root.clickFn, css: { today: _today }">
                <div class="_date" data-bind="text:dayStr"></div>
                <!-- ko foreach:data-->
                <div class="_item"></div>
                <!-- /ko -->
              </div>
              <!-- /ko -->
            </div>
          </div>
        </div>
	    </div>
	    <div class="hidebg">
        <span class="mui-icon mui-icon-close"></span>
        <!-- ko 'foreach':popData -->
        <div class="flex form-item" data-bind="click: $root.clickItem">
          <p class="flex-1 flex flex-row-center" data-bind="text: name"></p>
          <p class="flex-1 flex flex-row-center" data-bind="text: booktime"></p>
          <p class="flex flex-row-center" data-bind="css: 'status'+ status"><i class="iconfont icon-cshy-shizhong"></i><span data-bind="text: statusStr"></span></p>
        </div>
        <!-- /ko -->
      </div>
	  </div>
		<script src="../../third/knockout.js" ></script>
		<script src="../../js/mui.min.js"></script>
    <script src="../../js/mui.picker.min.js"></script>
    <script src="../../js/utils.config.js"></script>
    <script src="../../js/utils.extend.js"></script>
    <script src="../../js/utils.enums.js"></script>
    <script src="../../js/utils.storages.js" ></script>
    <script src="../../js/utils.auth.js"></script>
    <script src="../../js/utils.request.js"></script>
		<script>
		  window.addEventListener('refresh', function(e){
        location.reload();
      });
			(function($, doc) {
			  var headStr = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
        var getDays = function (year, month) {//获取月的天数
          return 32 - new Date(year, month - 1, 32).getDate();
        }
        var getDaysStr = function(year, month, data) {
          var _curDate = new Date();
          var _curDay = _curDate.getDate();
          var _curMonth = _curDate.getMonth() + 1;
          var _list = [];
          var _days = getDays(year, month);
          var _trimData = {};
          $.each(data, function(index, o) {
            var _d = o.booktime.split(' ')[0];
            o.statusStr = enums.planStatus[o.status];
            var _dlist = _d.split('-');
            if (_trimData[_dlist[2]]) {
              _trimData[_dlist[2]].push(o);
            } else {
              _trimData[_dlist[2]] = [o];
            }
          });
          for (var i = 1; i <= _days; i++) {
            var _data = {
                dayStr: '',//日期
                isCur: true,// 是否本月
                data: [],
                _today: false
            }
            var dstr =i > 9 ? i : '0' + i;
            _data.dayStr = dstr;
            if (_trimData[dstr]) {
              _data.data = _trimData[dstr];
            }
            if (i == _curDay && _curMonth == month) {
              _data._today = true;
            }
            _list.push(_data);
          }
          var firDayW = new Date(year, month - 1, 1);
          var firWeek = firDayW.getDay();
          for (var j = 1; j < firWeek; j++) {
            _list.unshift({
              dayStr: '',
              isCur: false,
              _today: false,
              data: []
            })
          }
          return _list;
        }
        var getList = function(times, callback) {
          var data = {
            page:1,
            times: times,
            limit:100000
          }
          request.loginAjax('project/getPatientList',{
            data: data,
            showMsg: false
          },function(data) {
            if (data && data.data) {
              callback(data.data);
            } else {
              callback([]);
            }
          }, function() {
            callback([]);
          });
        }
				$.init({
          preloadPages:[{
            id:'projectPlanDetail',
            url: './project-plan-detail.html'
          }]
        });
				$.plusReady(function() {
				  var $hidebg = doc.querySelector('.hidebg');
				  var $bgclose = doc.querySelector('.mui-icon-close');
          var times = '';
          // 修改时间
          var $dateinfo = doc.getElementById('dateinfo');
          var $datetxt = doc.getElementById('datetxt');
          var datepicer = new $.DtPicker({ type: 'month' });
          $dateinfo.addEventListener('tap', function(event) {
            setTimeout(function(){
              datepicer.show(function(rs) {
                $datetxt.innerText = rs.text;
                times = rs.text;
                initCalendar(rs.y.value, rs.m.value);
              });
            },500);
          }, false);
				  var viewModel = {
            headStr: ko.observableArray(headStr),
            MonthData: ko.observableArray([]),
            popData: ko.observableArray([]),
            clickFn: function (data) {
              if (data.data && data.data.length > 0) {
                $hidebg.style.display = 'block';
                viewModel.popData(data.data);
              }
            },
            clickItem: function(data) {
              var projectPlanDetailWebView = plus.webview.getWebviewById('projectPlanDetail');
              $.fire(projectPlanDetailWebView,'project-plan-id',{
                id:data.id
              });
              $.openWindow({
                id: 'projectPlanDetail'
              });
              $hidebg.style.display = 'none';
              viewModel.popData([]);
            }
          };
				  ko.applyBindings(viewModel, doc.getElementById('yuyueDate'));
				  // 关闭弹层
				  $bgclose.addEventListener('tap', function(){
				    $hidebg.style.display = 'none';
				    viewModel.popData([]);
				  });
				  // 显示日历
				  var initCalendar = function(year, month) {
				    times = year+'-'+month;
				    $datetxt.innerText = times;
            getList(times,function(res){
              var _days = getDaysStr(year,month, res);
              viewModel.MonthData(_days);
            });
				  }
				  // 初始化
				  var _date = new Date();
				  initCalendar(_date.getFullYear(), _date.getMonth()+1);
				  // 左右滑动
				  doc.getElementById('datebox').addEventListener('swipeleft', function(e) {
				    var _t = times.split('-');
				    var _year = _t[0];
				    var _month = _t[1];
				    if (_month == '12'){
				      _year = eval(_year + '+ 1');;
				      _month = 1;
				    } else {
				      _month = eval(_month + '+ 1');
				    }
				    initCalendar(_year, _month);
				  });
				  doc.getElementById('datebox').addEventListener('swiperight', function(e) {
            var _t = times.split('-');
            var _year = _t[0];
            var _month = _t[1];
            if (_month == '1'){
              _year = eval(_year + '- 1');;
              _month = 12;
            } else {
              _month = eval(_month + '- 1');
            }
            initCalendar(_year, _month);
          });
          // 修改刷新日历
          window.addEventListener('project-plan', function(e){
            var _t = times.split('-');
            var _year = _t[0];
            var _month = _t[1];
            initCalendar(_year, _month);
          });
          // 新增刷新日历
          window.addEventListener('bill-success', function(e){
            var _t = times.split('-');
            var _year = _t[0];
            var _month = _t[1];
            initCalendar(_year, _month);
          });
				});
			}(mui, document));
		</script>
	</body>

</html>