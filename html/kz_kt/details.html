<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <title></title>
  <link href="../../fonts/iconfont.css" rel="stylesheet" />
  <link href="../../css/mui.min.css" rel="stylesheet" />
  <link href="../../css/style.css" rel="stylesheet" />
  <link href="css/kt-style.css" rel="stylesheet" />
  <style>
    .mui-content{
      height: auto;
    }
    .video .video-item{
      box-shadow: none;
      -webkit-box-shadow: none;
    }
    .place-area{
      position: relative;
      padding-top: 40%;
      margin-top: 132px;
    }
  </style>
</head>

<body id="main-content">
  <header class="mui-bar mui-bar-nav">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title" data-bind="text:currentVideo().title"></h1>
  </header>
  <div class="mui-content details">
      <!--<div class="place-area"></div>-->
      <div class="video">
        <div class="video-item">
          <div id="videoplayer" class="thumbnail">
            <div class="img">
              <img src="images/1024x1024.png" alt="">
            </div>
            <i class="iconfont icon-bofang"></i>
          </div>
          <div class="info">
            <p class="clear curricu-name">
              <span class="fl font-bold text-ellipsis"  data-bind="text:detailData().title"></span>
              <span class="fr"  data-bind="text:detailData().gidText"></span>
            </p>
            <p class="clear curricu-desc">
              <span class="fl font-bold"  data-bind="text:detailData().contents"></span>
            </p>
            <p>
              <span class="price font-bold"  data-bind="text:detailData().priceText"></span>
            </p>
            <p class="clear other">
              <span class="fl" data-bind="text: currentVideo().ctime"></span>
              <span class="fr">
                <i class="iconfont icon-liulanjilu"></i>
                <span data-bind="text: currentVideo().views"></span>
              </span>
            </p>
          </div>
        </div>
      </div>
      <!-- ko if: ctype() == 2  -->
      <div class="number-box" style="height: 800px;">
        <div class="number">
            <div class="title clearFix">
              <span class="fl">剧集</span>
              <span class="fr">共<span data-bind="text: videoList().length"></span>集</span>
            </div>
            <div class="detailed">
              <!-- ko foreach: videoList  -->
              <p class="buy" data-bind="css: {active: $root.currentVideoId() == id},
                click: $root.playVideo">
                <!--<img src="images/yigou.png" alt="">-->
                <span data-bind="text: episodes"></span>
              </p>
              <!-- /ko -->
            </div>
        </div>
      </div>
      <!-- /ko -->
  </div>
  <script src="../../third/bluebird.min.js"></script>
  <script src="../../third/loadash.3.10.1.js"></script>
  <script src="../../js/mui.min.js"></script>
  <script src="../../third/knockout.js"></script>
  <script src="../../third/knockout.extend.js"></script>
  <script src="../../third/ko.mapping.js"></script>
  <script src="../../js/mui.picker.min.js"></script>
  <script src="../../js/mui.poppicker.js"></script>
  <script src="../../js/utils.enums.js"></script>
  <script src="../../js/utils.config.js"></script>
  <script src="../../js/utils.storages.js"></script>
  <script src="../../js/utils.category.js"></script>
  <script src="../../js/utils.auth.js"></script>
  <script src="../../js/utils.upload.js"></script>
  <script src="../../js/utils.request.js" ></script>
  <script src="../../js/utils.common.js" ></script>
  <script src="js/kt-common.js" ></script>
  <script>
    (function($, doc) {
      $.init();
      $.plusReady(function() {
        var currentWebview = plus.webview.currentWebview();
        // 课程id
        var cid = currentWebview.cid;
        // 当前要播放的视频id
        var vid = currentWebview.vid;
        // 视频播放
        var player = null;
        // 课程分类
        var category = categorys.get();
        // 创建播放区域
        function createVideoPlayer(url){
          if (player != null) {
            player.close();
          }
          player = new plus.video.VideoPlayer('videoplayer', {
            src: url,
            poster: 'http://pic25.nipic.com/20121112/9252150_150552938000_2.jpg',
            'show-center-play-btn': false,
            'show-fullscreen-btn': true,
            'show-play-btn': false,
            'show-progress': false,
            autoplay: true
          });
          plus.webview.currentWebview().append(player);
        }
        
        var BaseView = function () {
          var vm = this;
          vm.detailData = ko.observable({});
          // 课程类型
          vm.ctype = ko.observable();
          // 视频列表
          vm.videoList = ko.observableArray([]);
          // 当前正在播放的视频
          vm.currentVideo = ko.observable({});
          vm.currentVideoId = ko.observable();
          // 播放当前视频
          vm.playVideo = function(data){
            vm.currentVideo(ko.mapping.fromJS(data));
            vm.currentVideoId(data.id);
            createVideoPlayer(data.urls);
          }
        }
        var viewModel = new BaseView();
        ko.applyBindings(viewModel, doc.getElementById('main-content'));
        
//      function loadBuy () {
//        request.loginAjax('courses/purchaseCoursesDetailsByCid', {
//          showMsg: false,
//          data: {
//            cid: cid
//          }
//        }, function(data,success) {
//          if (success) { 
//          }
//        });
//      }
        // 视频观看记录
        function readVideo (videoid) {
          request.loginAjax('coursesvideos/storageViewVideoRecord', {
            showMsg: false,
            data: {
              vid: videoid
            }
          }, function(data,success) {
            
          });
        }
        // 加载课程
        function loadData () {
          request.loginAjax('courses/coursesDetails', {
            showMsg: false,
            data: {
              cid: cid
            }
          }, function(data,success) {
            if (success) { 
              viewModel.ctype(data.ctype);
              data.gidText = '';
              _.find(category, function(c) {
                if (c.id == data.gid) {
                  data.gidText = c.title;
                  return true;
                }
                return false;
              });
              data.priceText = data.price > 0 ? data.price : '免费';
              viewModel.detailData(ko.mapping.fromJS(data));
              viewModel.videoList(data.videosList);
              // 查找要播放的视频
              if (data.videosList && data.videosList.length > 0) {
                var curVideo = _.find(data.videosList, function(o){
                  return o.id == vid;
                });
                if (curVideo) {
                  
                } else {
                  curVideo = data.videosList[0];
                }
                viewModel.currentVideo(ko.mapping.fromJS(curVideo));
                viewModel.currentVideoId(curVideo.id);
//              createVideoPlayer('http://m.tianchiyueya.com:1888//curriculum//videos//20190823//b32788362c13094ff60144233284687c.mp4');
                createVideoPlayer(curVideo.urls);
                readVideo(curVideo.id);
              }
            }
          });
        }
        loadData();
//      createVideoPlayer('http://m.tianchiyueya.com:1888/Public/plug/editor/attached/file/20161122/20161122084359_80166.mp4');
      });
    }(mui, document));
  </script>
</body>
</html>