<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <title></title>
  <link href="../../fonts/iconfont.css" rel="stylesheet" />
  <link href="../../css/mui.min.css" rel="stylesheet" />
  <link href="../../css/style.css" rel="stylesheet" />
  <link href="css/kt-style.css" rel="stylesheet" />
  <style>
    .mui-content{
      height: auto;
      padding-bottom: 50px;
    }
    .bottom-buy{
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      height: 50px;
    }
    .bottom-buy .btn{
      width: 30%;
      -webkit-border-radius: 0;
      border-radius: 0;
      line-height: 38px;
      border-color: #8E78D6;
      background-color: #8E78D6!important;
    }
  </style>
</head>

<body id="main-content">
  <header class="mui-bar mui-bar-nav">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title">立即购买</h1>
  </header>
  <div class="bottom-buy flex">
    <div class="flex-1">
      
    </div>
    <button data-bind="click: buyNow" class="btn">立即购买</button>
  </div>
  <div class="mui-content details">
    <div class="number-box">
      <div class="number">
          <div class="title clearFix">
            <span class="fl">剧集</span>
            <span class="fr">共<span data-bind="text: videoList().length"></span>集</span>
          </div>
          <div class="detailed">
            <p class="buy" data-bind="click: $root.chooseAll">
              <!-- ko if: buyOut() -->
              <img src="images/yigou.png" alt="">
              <!-- /ko -->
              <span>全套</span>
            </p>
            <!-- ko foreach: videoList  -->
            <p class="buy" data-bind="click: $root.choose">
              <!-- ko if: _buy -->
              <img src="images/yigou.png" alt="">
              <!-- /ko -->
              <span data-bind="text: episodes"></span>
            </p>
            <!-- /ko -->
          </div>
      </div>
    </div>
  </div>
  <script src="../../third/bluebird.min.js"></script>
  <script src="../../third/loadash.3.10.1.js"></script>
  <script src="../../js/mui.min.js"></script>
  <script src="../../third/knockout.js"></script>
  <script src="../../third/knockout.extend.js"></script>
  <script src="../../third/ko.mapping.js"></script>
  <script src="../../js/mui.picker.min.js"></script>
  <script src="../../js/mui.poppicker.js"></script>
  <script src="../../js/utils.enums.js"></script>
  <script src="../../js/utils.config.js"></script>
  <script src="../../js/utils.storages.js"></script>
  <script src="../../js/utils.category.js"></script>
  <script src="../../js/utils.auth.js"></script>
  <script src="../../js/utils.upload.js"></script>
  <script src="../../js/utils.request.js" ></script>
  <script src="../../js/utils.common.js" ></script>
  <script src="js/kt-common.js" ></script>
  <script>
    (function($, doc) {
      $.init();
      $.plusReady(function() {
        // 当前用户id
        var curuserid = authManage.getUser().id;
        var currentWebview = plus.webview.currentWebview();
        // 课程id
        var cid = currentWebview.cid;
        // 存储购买记录
        function BuyServer (postData, callback) {
          request.loginAjax('coursesuser/storagePaidCourseInfo', {
            showMsg: false,
            data: postData
          }, function(data,success) {
            if (success) { 
              callback()
            }
          });
        }
        var BaseView = function () {
          var vm = this;
          // 是否当前用户发布的
          vm.isMine = ko.observable(false);
          // 是否免费
          vm.isFree = ko.observable(false);
          // 是否买断
          vm.buyOut = ko.observable(false);
          // 视频列表
          vm.videoList = ko.observableArray([]);
          
          // 立即购买
          vm.buyNow = function() {
            BuyServer({
              cid: cid,
              multiinfo: 'egg',
              amounts: 0.1
            }, function(){
              
            })
          }
          // 选择买断
          vm.chooseAll = function () {
            
          }
          // 选择购买
          vm.choose = function () {
            
          }
        }
        var viewModel = new BaseView();
        ko.applyBindings(viewModel, doc.getElementById('main-content'));
        // 加载已购买记录
        function loadBuy (videoList, callback) {
          request.loginAjax('courses/purchaseCoursesDetailsByCid', {
            showMsg: false,
            data: {
              cid: cid
            }
          }, function(data,success) {
            if (success) {
              if (!!data.multiinfo) {
                // 买断则全部已购买
                if (data.multiinfo.indexOf('egg') >= 0) {
                  viewModel.buyOut(true);
                  _.forEach(videoList, function(item){
                    item._buy = true;
                  });
                } else {
                  // 查找已购买课程
                  var ids = data.multiinfo.split(',');
                  _.forEach(videoList, function(item){
                    var exist = _.find(ids, function(_id){
                      return _id == item.id;
                    })
                    if (exist) {
                      item._buy = true;
                    }
                  });
                }
              }
            }
            callback(videoList);
          }, function(){
            callback(videoList);
          });
        }
        // 加载课程
        function loadData () {
          request.loginAjax('courses/coursesDetails', {
            showMsg: false,
            data: {
              cid: cid
            }
          }, function(data,success) {
            if (success) { 
              viewModel.isMine(data.uid == curuserid);
              if (!(data.price > 0)) {
                viewModel.isFree(true);
              }
              _.forEach(data.videosList, function(item){
                item._buy = false;
              });
              // 非自己的且付费的则查询是否已购买视频
              if (!viewModel.isMine() && !viewModel.isFree()) {
                loadBuy(data.videosList, function(result){
                  viewModel.videoList(result);
                });
              } else {
                viewModel.videoList(data.videosList);
              }
            }
          });
        }
        loadData();
      });
    }(mui, document));
  </script>
</body>
</html>