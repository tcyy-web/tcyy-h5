<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
  <title></title>
  <link href="../../fonts/iconfont.css" rel="stylesheet" />
  <link href="../../css/mui.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../../css/mui.picker.min.css">
  <link rel="stylesheet" href="../../css/mui.poppicker.css">
  <link href="../../css/style.css" rel="stylesheet" />
  <link href="../../css/style-custom.css" rel="stylesheet" />
  <link href="css/kt-style.css" rel="stylesheet" />
  <style>
    .mui-content{
      height: auto;
      padding-bottom: 100px;
    }
    .publish-btn{
      position: fixed;
      bottom: 0;
      left: 0;
      z-index: 100;
      width: 100%;
      text-align: center;
      color: #fff;
      font-size: 16px;
    }
    .publish-btn > div{
      position: relative;
      background-color: #8E78D6;
      height: 50px;
      line-height: 50px;
    }
    .publish-btn .iconfont{
      font-size: 30px;
      vertical-align: middle;
      margin-right: 8px;
      position: relative;
      top: -2px;
    }
    .publish-btn > div:before{
      position: absolute;
      left: 0;
      right: 0;
      top:0;
      height: 1px;
      background-color: rgba(255, 255, 255, 0.5);
      z-index: 2;
      content: '';
    }
    .publish-btn > div:first-child:before{
      display: none;
    }
  </style>
</head>

<body>
  <header class="mui-bar mui-bar-nav">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title">视频发布</h1>
  </header>
  <div class="publish-btn">
    <div id="startVideo"><i class="iconfont icon-luxiangji"></i><span>开始录像</span></div>
    <div id="startPick"><i class="iconfont icon-congxiangcedaoru"></i><span>从手机中选择</span></div>
  </div>
  <div class="mui-content" id="main-content">
    <form class="mui-input-group kt-form-group">
      <div class="mui-input-row">
        <label><i class="form-required"></i>课程类型：</label>
        <p data-bind="text: !formData.ctypeText() ? '请选择' : formData.ctypeText, 
          click: ctypeClick">请选择</p>
      </div>
      <div class="mui-input-row">
        <label><i class="form-required"></i>课程分类：</label>
        <p data-bind="text: !formData.gidText() ? '请选择' : formData.gidText, 
          click: gidClick">请选择</p>
      </div>
      <div class="mui-input-row">
        <label><i class="form-required"></i>课程标题：</label>
        <input data-bind="value: formData.ctitle, muiInput: formData.ctitle" maxlength="30" type="text" class="mui-input-clear" placeholder="课程标题">
      </div> 
      <div class="mui-input-row auto">
        <label><i class="form-required"></i>课程描述：</label>
        <div>
          <textarea data-bind="textInput: formData.ccontents" rows="5" maxlength="200" placeholder="请简单描述课程"></textarea>
        </div>
      </div> 
      <div class="mui-input-row">
        <label><i class="form-required"></i>课程单价：</label>
        <input data-bind="value: formData.price, muiInput: formData.price" maxlength="9" type="text" class="mui-input-clear" placeholder="课程单集视频售价">
      </div>
      <div class="mui-input-row">
        <label><i class="form-required"></i>买断价：</label>
        <input data-bind="value: formData.oneprice, muiInput: formData.oneprice" maxlength="9" type="text" class="mui-input-clear" placeholder="买断课程视频价格">
      </div>
      <div class="mui-input-row">
        <label>视频标题：</label>
        <input data-bind="value: formData.vtitle, muiInput: formData.vtitle" maxlength="10" type="text" class="mui-input-clear" placeholder="单个视频显示标题">
      </div> 
    </form>
  </div>
  <script src="../../third/bluebird.min.js"></script>
  <script src="../../third/loadash.3.10.1.js"></script>
  <script src="../../js/mui.min.js"></script>
  <script src="../../third/knockout.js"></script>
  <script src="../../third/ko.mapping.js"></script>
  <script src="../../js/mui.picker.min.js"></script>
  <script src="../../js/mui.poppicker.js"></script>
  <script src="../../js/utils.enums.js"></script>
  <script src="../../js/utils.config.js"></script>
  <script src="../../js/utils.storages.js"></script>
  <script src="../../js/utils.category.js"></script>
  <script src="../../js/utils.auth.js"></script>
  <script src="../../js/utils.upload.js"></script>
  <script src="../../js/utils.request.js" ></script>
  <script src="../../js/utils.common.js" ></script>
  <script src="js/kt-common.js" ></script>
  <script>
    (function($, doc) {
      $.init();
      $.plusReady(function() {
        // 视频类型选择
        var ctypePicker = new $.PopPicker({
        });
        ctypePicker.setData([
          { value: 1, text: '单集'},
          { value: 2, text: '多集'}
        ]);
        // 分类选择
        var gidPicker = new $.PopPicker();
        var caList = categorys.get(),gList = [];
        for( var i = 0 ; i< caList.length ; i++ ){
          	gList.push({
          		value:caList[i].id,
          		text:caList[i].title
          	})
        }
        gidPicker.setData( gList );
        
        var BaseView = function () {
          var vm = this;
          vm.formData = { 
            ctype: ko.observable(), 
            ctypeText: ko.observable(''), 
            	gid: ko.observable(),
            	gidText: ko.observable(''),
            	ctitle: ko.observable(''), 
            	ccontents: ko.observable(''),
            	price: ko.observable(),
						oneprice:ko.observable(),
            	vtitle:ko.observable(),
            	urls:ko.observable(),
						episodes:1 
          }
          
          vm.ctypeClick = function(){
            setTimeout(function() {
              ctypePicker.show(function(items) {
                vm.formData.ctype(items[0].value);
                vm.formData.ctypeText(items[0].text);
              });
            }, 500);
          }
          
          vm.gidClick = function(){
            setTimeout(function() {
              gidPicker.show(function(items) {
                vm.formData.gid(items[0].value);
                vm.formData.gidText(items[0].text);
              });
            }, 500);
          }
          
        }
        var viewModel = new BaseView();
        ko.applyBindings(viewModel, document.getElementById('main-content')); 
        function checkData () {
          return new Promise(function(resolve){
            
            var postData = ko.mapping.toJS(viewModel.formData);
            if (!postData.ctype) {
              mui.toast('请选择课程类型')
              return;
            }
            if (!postData.gid) {
              mui.toast('请选择课程分类')
              return;
            }
            if (!postData.ctitle) {
              mui.toast('请输入课程标题')
              return;
            }
            if (!postData.ccontents) {
              mui.toast('请输入课程描述')
              return;
            }
            if (!postData.price) {
              mui.toast('请输入课程单价')
              return;
            }
            if (!postData.oneprice) {
              mui.toast('请输入买断价')
              return;
            }
            resolve();
          })
        }
        //发布课程
        var saveVedioInfo = function (videourl) {
          return new Promise(function(resolve){
            var postData = ko.mapping.toJS(viewModel.formData);
            postData.urls = videourl;
            // 暂时写死地址测试
            postData.urls = 'http://m.tianchiyueya.com:1888//curriculum//videos//20190823//b32788362c13094ff60144233284687c.mp4';
            request.loginAjax('courses/saveCourseAndVideos', {
              data: postData
            }, function(data,success) {     
              if (success) {   
                resolve()
              }
            });
          });
        }
        
        doc.getElementById('startVideo').addEventListener('tap', function(e) {
          checkData().then(function(){
            upload.getVideo(function(file){
              var url = config.url + "Uploads/Files";
              upload.uploadMedia(url, function(res) {
                saveVedioInfo(res[0].showUrl)
              }, { abspath: file, type: '5' });
            })
          })
        });
                
        doc.getElementById('startPick').addEventListener('tap', function(e) {
          checkData().then(function(){
            upload.galleryVideo(function(file){
              var url = config.url + "Uploads/Files";
              upload.uploadMedia(url, function(res) {
                saveVedioInfo(res[0].showUrl)
              }, { abspath: file, type: '5' });
            })
          })
        });
      });
    }(mui, document));
  </script>
</body>
</html>